---
title: "Comparative analysis of the Kluc tumor scRNAseq data"
author: "heinin"
date: "2024-02-26"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Introduction

Adding annotations and comparing treatment groups/timepoints.

### Packages and environment variables

```{r, warning=F, message=F}

suppressPackageStartupMessages({
  #library(cli)
  library(Seurat)
  library(SeuratObject)
  library(SeuratDisk)
  library(tidyverse)
  library(tibble)
  library(ggplot2)
  library(ggpubr)
  library(ggrepel)
  library(workflowr)
  library(googlesheets4)
  library(scProportionTest)})

setwd("/home/hnatri/PD1_mm/")
set.seed(9999)
options(ggrepel.max.overlaps = Inf)

# Colors, themes, cell type markers, and plot functions
source("/home/hnatri/PD1_mm/code/utilities.R")
source("/home/hnatri/PD1_mm/code/PD1_mm_themes.R")
source("/home/hnatri/PD1_mm/code/CART_plot_functions.R")

```

### Importing data

```{r}

seurat_data <- readRDS("/tgen_labs/banovich/BCTCSF/PD1_mm_Seurat/PD1_mm_Seurat_merged.Rds")

```

### DimPlot of cell type annotations

```{r}

celltypes <- sort(as.character(unique(seurat_data$celltype)))
plot_colors <- colorRampPalette(brewer.pal(11, "Paired"))(length(celltypes))
names(plot_colors) <- celltypes

DimPlot(seurat_data,
        group.by = "celltype",
        reduction = "umap",
        raster = T,
        label = T,
        cols = plot_colors) &
  coord_fixed(ratio = 1) &
  theme_bw() &
  NoLegend()

DimPlot(seurat_data,
        group.by = "celltype",
        split.by = "Treatment",
        reduction = "umap",
        raster = T,
        #label = T,
        cols = plot_colors) &
  coord_fixed(ratio = 1) &
  theme_bw() &
  NoLegend()

```

### Cell type proportion differences

In scatter plots, the proportions of cell types in each pair of treatment groups
are plotted against each other with one group on each axis. The forest plots show
the significance level.

```{r}

unique(seurat_data$Treatment)
unique(seurat_data$Day)

table(seurat_data$celltype, seurat_data$Treatment)

create_clusterpropplot(seurat_data,
                       group_var = "Treatment",
                       group1 = "ADJ",
                       group2 = "CTRL",
                       plot_var = "celltype",
                       plot_colors = plot_colors,
                       var_names = c("ADJ", "CTRL"),
                       legend_title = "Treatment")

create_clusterpropplot(seurat_data,
                       group_var = "Treatment",
                       group1 = "NEO",
                       group2 = "CTRL",
                       plot_var = "celltype",
                       plot_colors = plot_colors,
                       var_names = c("NEO", "CTRL"),
                       legend_title = "Treatment")

create_clusterpropplot(seurat_data,
                       group_var = "Treatment",
                       group1 = "ADJ",
                       group2 = "NEO",
                       plot_var = "celltype",
                       plot_colors = plot_colors,
                       var_names = c("ADJ", "NEO"),
                       legend_title = "Treatment")

# Day 12
create_clusterpropplot(subset(seurat_data, subset = Day == 12),
                       group_var = "Treatment",
                       group1 = "NEO",
                       group2 = "CTRL",
                       plot_var = "celltype",
                       plot_colors = plot_colors,
                       var_names = c("NEO", "CTRL"),
                       legend_title = "Treatment, Day 12")

# Day 16
create_clusterpropplot(subset(seurat_data, subset = Day == 16),
                       group_var = "Treatment",
                       group1 = "ADJ",
                       group2 = "CTRL",
                       plot_var = "celltype",
                       plot_colors = plot_colors,
                       var_names = c("ADJ", "CTRL"),
                       legend_title = "Treatment, Day 16")

create_clusterpropplot(subset(seurat_data, subset = Day == 16),
                       group_var = "Treatment",
                       group1 = "NEO",
                       group2 = "CTRL",
                       plot_var = "celltype",
                       plot_colors = plot_colors,
                       var_names = c("NEO", "CTRL"),
                       legend_title = "Treatment, Day 16")

create_clusterpropplot(subset(seurat_data, subset = Day == 16),
                       group_var = "Treatment",
                       group1 = "ADJ",
                       group2 = "NEO",
                       plot_var = "celltype",
                       plot_colors = plot_colors,
                       var_names = c("ADJ", "NEO"),
                       legend_title = "Treatment, Day 16")


# Using scProportionTest
prop_test <- sc_utils(seurat_data)

prop_test <- permutation_test(
  prop_test, cluster_identity = "celltype",
  sample_1 = "CTRL", sample_2 = "ADJ",
  sample_identity = "Treatment")

perm_plot <- permutation_plot(prop_test)

perm_plot + scale_colour_manual(values = c("tomato", "azure2")) +
  #NoLegend() +
  ggtitle("ADJ vs. CTRL, all timepoints")

prop_test <- permutation_test(
  prop_test, cluster_identity = "celltype",
  sample_1 = "CTRL", sample_2 = "NEO",
  sample_identity = "Treatment")

perm_plot <- permutation_plot(prop_test)

perm_plot + scale_colour_manual(values = c("tomato", "azure2")) +
  #NoLegend() +
  ggtitle("NEO vs. CTRL, all timepoints")

prop_test <- permutation_test(
  prop_test, cluster_identity = "celltype",
  sample_1 = "ADJ", sample_2 = "NEO",
  sample_identity = "Treatment")

perm_plot <- permutation_plot(prop_test)

perm_plot + scale_colour_manual(values = c("tomato", "azure2")) +
  #NoLegend() +
  ggtitle("NEO vs. ADJ, all timepoints")

# Day 12 only
# For day 12, no ADJ sample
prop_test <- sc_utils(subset(seurat_data, subset = Day == 12))

prop_test <- permutation_test(
  prop_test, cluster_identity = "celltype",
  sample_1 = "CTRL", sample_2 = "NEO",
  sample_identity = "Treatment")

perm_plot <- permutation_plot(prop_test)

perm_plot + scale_colour_manual(values = c("tomato", "azure2")) +
  #NoLegend() +
  ggtitle("NEO vs. CTRL, day 12")

# Day 16 only
prop_test <- sc_utils(subset(seurat_data, subset = Day == 16))

prop_test <- permutation_test(
  prop_test, cluster_identity = "celltype",
  sample_1 = "CTRL", sample_2 = "ADJ",
  sample_identity = "Treatment")

perm_plot <- permutation_plot(prop_test)

perm_plot + scale_colour_manual(values = c("tomato", "azure2")) +
  #NoLegend() +
  ggtitle("ADJ vs. CTRL, day 16")

prop_test <- permutation_test(
  prop_test, cluster_identity = "celltype",
  sample_1 = "CTRL", sample_2 = "NEO",
  sample_identity = "Treatment")

perm_plot <- permutation_plot(prop_test)

perm_plot + scale_colour_manual(values = c("tomato", "azure2")) +
  #NoLegend() +
  ggtitle("NEO vs. CTRL, day 16")

prop_test <- permutation_test(
  prop_test, cluster_identity = "celltype",
  sample_1 = "ADJ", sample_2 = "NEO",
  sample_identity = "Treatment")

perm_plot <- permutation_plot(prop_test)

perm_plot + scale_colour_manual(values = c("tomato", "azure2")) +
  #NoLegend() +
  ggtitle("NEO vs. ADJ, day 16")

```

### Cluster markers

```{r}

# Dropping MT and RP genes before calling markers
RBMTgenes <- grep(pattern = "^RP[SL]|^MRP[SL]|^MT-",
                  x = rownames(seurat_data@assays$RNA_human@data),
                  value = TRUE, invert = TRUE)
seurat_data <- subset(seurat_data, features = RBMTgenes)

# Top markers for each cluster
markers <- presto::wilcoxauc(seurat_data,
                             group_by = "celltype",
                             assay = "data",
                             seurat_assay = "RNA_human")

sig_markers <- markers %>% filter(auc>0.8, padj<0.01)

dim(sig_markers)
table(sig_markers$group)

table(sig_markers$group) %>% as.data.frame() %>%
  ggplot(aes(x = reorder(Var1, -Freq), y = Freq, fill = Var1)) +
    geom_bar(stat = "identity") +
    scale_fill_manual(values = plot_colors) +
    theme_classic2() +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
    NoLegend() +
    xlab("Cell type") +
    ylab("# cell type markers")

# Saving to a file
write.table(sig_markers, "/scratch/hnatri/CART/PD1_CART_celltype_markers.tsv",
            sep = "\t", quote = F, row.names = F)

# Top markers for each cluster
sig_markers %>% group_by(group) %>% slice_max(order_by = auc, n = 10)

```

### DEGs between treatment groups

```{r}
# For each cluster, top DEGs between NEO and CTRL
DEG_NEO_CTRL <- lapply(unique(seurat_data$celltype), function(xx){
  data_subset <- subset(seurat_data, subset = celltype == xx)
  if (all((c("NEO", "CTRL") %in% data_subset$Treatment) == c(T, T))){
    markers <- presto::wilcoxauc(data_subset,
                                 group_by = "Treatment",
                                 groups_use = c("NEO", "CTRL"),
                                 assay = "data",
                                 seurat_assay = "RNA_human")
    markers$celltype <- xx
    
    return(markers)
  } else {
    return(NULL)
  }
})
names(DEG_NEO_CTRL) <- unique(seurat_data$celltype)
DEG_NEO_CTRL[sapply(DEG_NEO_CTRL, is.null)] <- NULL

DEG_NEO_CTRL_df <- as.data.frame(do.call(rbind, DEG_NEO_CTRL))

DEG_NEO_CTRL_df_sig <- DEG_NEO_CTRL_df %>%
  filter(group=="NEO",
         padj < 0.01,
         auc > 0.6,
         (pct_in > 50 | pct_out > 50))

# Saving to a file
write.table(DEG_NEO_CTRL_df_sig, "/scratch/hnatri/CART/PD1_CART_DEG_NEO_CTRL_sig.tsv",
            sep = "\t", quote = F, row.names = F)

# Plotting numbers of DEGs
table(DEG_NEO_CTRL_df_sig$celltype) %>% as.data.frame() %>%
  ggplot(aes(x = reorder(Var1, -Freq), y = Freq, fill = Var1)) +
    geom_bar(stat = "identity") +
    scale_fill_manual(values = plot_colors) +
    theme_classic2() +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
    NoLegend() +
    xlab("Cell type") +
    ylab("# DEGs, NEO vs. CTRL, all timepoints")

# Top DEGs for each cluster
DEG_NEO_CTRL_df_sig %>% group_by(group) %>% slice_max(order_by = auc, n = 10)

# For each cluster, top DEGs between NEO and ADJ
DEG_NEO_ADJ <- lapply(unique(seurat_data$celltype), function(xx){
  data_subset <- subset(seurat_data, subset = celltype == xx)
  if (all((c("NEO", "ADJ") %in% data_subset$Treatment) == c(T, T))){
    markers <- presto::wilcoxauc(data_subset,
                                 group_by = "Treatment",
                                 groups_use = c("NEO", "ADJ"),
                                 assay = "data",
                                 seurat_assay = "RNA_human")
    markers$celltype <- xx
    
    return(markers)
  } else {
    return(NULL)
  }
})
names(DEG_NEO_ADJ) <- unique(seurat_data$celltype)
DEG_NEO_ADJ[sapply(DEG_NEO_ADJ, is.null)] <- NULL

DEG_NEO_ADJ_df <- as.data.frame(do.call(rbind, DEG_NEO_ADJ))

DEG_NEO_ADJ_df_sig <- DEG_NEO_ADJ_df %>%
  filter(group == "NEO",
         padj < 0.01,
         auc > 0.6,
         (pct_in > 50 | pct_out > 50))

# Saving to a file
write.table(DEG_NEO_ADJ_df_sig, "/scratch/hnatri/CART/PD1_CART_DEG_NEO_ADJ_sig.tsv",
            sep = "\t", quote = F, row.names = F)

# Plotting
table(DEG_NEO_ADJ_df_sig$celltype) %>% as.data.frame() %>%
  ggplot(aes(x = reorder(Var1, -Freq), y = Freq, fill = Var1)) +
    geom_bar(stat = "identity") +
    scale_fill_manual(values = plot_colors) +
    theme_classic2() +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
    NoLegend() +
    xlab("Cell type") +
    ylab("# DEGs, NEO vs. ADJ, all timepoints")

# Top DEGs for each cluster
DEG_NEO_ADJ_df_sig %>% group_by(group) %>% slice_max(order_by = auc, n = 10)

# For each cluster, top DEGs between ADJ and CTRL
DEG_ADJ_CTRL <- lapply(unique(seurat_data$celltype), function(xx){
  data_subset <- subset(seurat_data, subset = celltype == xx)
  if (all((c("ADJ", "CTRL") %in% data_subset$Treatment) == c(T, T))){
    markers <- presto::wilcoxauc(data_subset,
                                 group_by = "Treatment",
                                 groups_use = c("ADJ", "CTRL"),
                                 assay = "data",
                                 seurat_assay = "RNA_human")
    markers$celltype <- xx
    
    return(markers)
  } else {
    return(NULL)
  }
})
names(DEG_ADJ_CTRL) <- unique(seurat_data$celltype)
DEG_ADJ_CTRL[sapply(DEG_ADJ_CTRL, is.null)] <- NULL

DEG_ADJ_CTRL_df <- as.data.frame(do.call(rbind, DEG_ADJ_CTRL))

DEG_ADJ_CTRL_df_sig <- DEG_ADJ_CTRL_df %>%
  filter(group == "NEO",
         padj < 0.01,
         auc > 0.6,
         (pct_in > 50 | pct_out > 50))

# Saving to a file
write.table(DEG_ADJ_CTRL_df_sig, "/scratch/hnatri/CART/PD1_CART_DEG_ADJ_CTRL_sig.tsv",
            sep = "\t", quote = F, row.names = F)

# Plotting
table(DEG_ADJ_CTRL_df_sig$celltype) %>% as.data.frame() %>%
  ggplot(aes(x = reorder(Var1, -Freq), y = Freq, fill = Var1)) +
    geom_bar(stat = "identity") +
    scale_fill_manual(values = plot_colors) +
    theme_classic2() +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
    NoLegend() +
    xlab("Cell type") +
    ylab("# DEGs, ADJ vs. CTRL, all timepoints")

# Top DEGs for each cluster
DEG_ADJ_CTRL_df_sig %>% group_by(group) %>% slice_max(order_by = auc, n = 10)

```

### Human T cell canonical markers

```{r}

# Canonical T cell markers
gs4_deauth()
canonical_markers  <- gs4_get("https://docs.google.com/spreadsheets/d/186PIcU3Jb0Xm3IuZgENEChluykvwsK4JnHF8FbeJASA/edit?usp=sharing")
sheet_names(canonical_markers)
canonical_markers <- read_sheet(canonical_markers, sheet = "T cells, gene sets")
head(canonical_markers)

# Overlapping with cluster markers
sig_markers %>% filter(feature %in% canonical_markers$RNA)
canonical_markers %>% filter(RNA %in% sig_markers$feature) %>% as.data.frame()

# Overlapping with DEGs
DEG_NEO_CTRL_df_sig %>% filter(feature %in% canonical_markers$RNA)
DEG_NEO_ADJ_df_sig %>% filter(feature %in% canonical_markers$RNA)

```
